---
title: "Neuroblastoma batch correction"
author: "Health Data Science Unit"
date: "`r date()`"
output: 
   html_document:
           code_folding: hide
---


```{r include=FALSE}
library(Seurat)
library(tidyverse)
library(gridExtra)
library(knitr)
library(liger)
library(SeuratWrappers)

knitr::opts_chunk$set(warning = FALSE,
                      message = FALSE,
                      cache = TRUE,
                      fig.align = TRUE,
                      fig.height = 8,
                      fig.width = 10, 
                      cache.lazy = FALSE)
```

## Adrenal Medulla 
        
```{r}
## Loading annotations
adrenal_ann <- read.table('../data/cell_type_annotation_medulla.tsv', sep = '\t',
                          stringsAsFactors = FALSE)
adrenal_ann <- mutate(adrenal_ann, barcodes=rownames(adrenal_ann))
```


```{r results='asis'}
plot_seurat <- function(file_url='seurat.rds', annotation) {
       sample <- readRDS(file_url) 
       sam_ann <- data.frame(barcodes=colnames(sample), stringsAsFactors = FALSE)
       metadata <- merge(sam_ann, annotation)
       sample$'cell_type' <- metadata$Idents.combined_all_med.
       DimPlot(sample, group.by = 'cell_type' , reduction = 'umap', label = TRUE) + NoLegend()
}
```


## <span style='color:red'> Reproducibility of clusters </span> (OUTDATED) {.tabset} 



### Sample 13363

```{r echo=FALSE}
plot_seurat('../data/13363_med_seurat.rds', adrenal_ann)
```

### Sample 13367

```{r echo=FALSE}
plot_seurat('../data/13567_med_seurat.rds', adrenal_ann)
```

### Sample 13667

```{r echo=FALSE}
plot_seurat('../data/13667_med_seurat.rds', adrenal_ann)
```

### Sample 13952

```{r echo=FALSE}
plot_seurat('../data/13952_med_seurat.rds', adrenal_ann)
```

### Sample 14164

```{r echo=FALSE}
plot_seurat('../data/14164_med_seurat.rds', adrenal_ann)
```

### Sample 14490
```{r echo=FALSE}
plot_seurat('../data/14490_med_seurat.rds', adrenal_ann)
```

### Sample 14627

```{r echo=FALSE}
plot_seurat('../data/14627_med_seurat.rds', adrenal_ann)
```

### Sample 14707

```{r echo=FALSE}
plot_seurat('../data/14707_med_seurat.rds', adrenal_ann)
```

### Sample 14742

```{r echo=FALSE}
plot_seurat('../data/14742_med_seurat.rds', adrenal_ann)
```

### Sample 14766

```{r echo=FALSE}
plot_seurat('../data/14766_med_seurat.rds', adrenal_ann)
```

### Sample 14773

```{r echo=FALSE}
plot_seurat('../data/14773_med_seurat.rds', adrenal_ann)
```

### Sample 14933

```{r echo=FALSE}
plot_seurat('../data/14933_med_seurat.rds', adrenal_ann)
```

### Sample 15084

```{r echo=FALSE}
plot_seurat('../data/15084_med_seurat.rds', adrenal_ann)
```

### Sample 15161

```{r echo=FALSE}
plot_seurat('../data/15161_med_seurat.rds', adrenal_ann)
```




## <span style='color:red'> Batch correction </span>

```{r echo=FALSE}
adrenal <- read_rds('../data/batch_correction_adrenal_medulla_tsne.rds')
by_signature <- adrenal$tsne_coords %>%
                as.data.frame %>%
                rename(tSNE1=V1, tSNE2=V2) %>%
                ggplot(aes(tSNE1, tSNE2, colour = adrenal$clusters)) +
                    geom_point(alpha = 0.4, size = 2) + 
                    theme_classic() +
                    theme(legend.title = element_blank(),
                          legend.position = 'bottom') +
                    ggtitle('By signature')

```

```{r echo=FALSE}
by_dataset <- adrenal$tsne_coords %>%
                as.data.frame %>%
                rename(tSNE1=V1, tSNE2=V2) %>%
                ggplot(aes(tSNE1, tSNE2, colour = adrenal$cell_data$dataset)) +
                    geom_point(alpha = 0.5, size = 1.5) + 
                    theme_classic() +
                    theme(legend.title = element_blank()) +
                    ggtitle('By dataset')

```

```{r echo=FALSE}
by_dataset
```

```{r echo=FALSE}
coords <- adrenal$tsne_coords %>% 
              as.data.frame %>%
              rename(tSNE1=V1, tSNE2=V2) %>%
              mutate(barcodes = rownames(adrenal$tsne_coords))
coords_ann <- merge(coords, adrenal_ann) 

by_cell_type <- coords_ann %>% 
         ggplot(aes(tSNE1, tSNE2, colour = Idents.combined_all_med.)) +
         geom_point(alpha = 0.5, size = 1.5) + 
         theme_classic() +
         theme(legend.title = element_blank(),
               legend.position = 'bottom') +
          ggtitle('By cell type')
```

### <span style='color:red'> Clusters in batch corrected data </span> (OUTDATED)

```{r echo=FALSE}
grid.arrange(by_signature, by_cell_type, ncol=2)
```







```{r echo=FALSE, eval=FALSE}
## Glandulla projection
## Batch correction
## Loading glandulla projection
neuro_seu <- readRDS('../data/batch_correction.rds')
neuro_umap <- RunUMAP(neuro_seu, dims=1:8, reduction = 'iNMF')
DimPlot(neuro_umap, reduction = 'umap', group.by = 'orig.ident')
```


```{r eval=FALSE, echo=FALSE}
## Loading data
file_names <- list.files('../data/intratumoral/', full.names=TRUE)
f_names <- gsub('../data/intratumoral/', '', file_names)
f_names <- gsub('_.*|/', '', f_names)
f_names <- gsub('\\.rds', '', f_names)
f_names

seurat <- lapply(file_names, readRDS)
seurat <- merge(x = seurat[[1]], y = seurat[2:length(seurat)])
saveRDS(seurat, '../data/intratumoral_merged_seurat.rds')
```


```{r eval=FALSE, echo=FALSE}
seurat.p <- readRDS('../data/intratumotal_liger_seurat.rds')
seurat.p <- RunUMAP(seurat.p, dims=1:8, reduction = 'iNMF')
DimPlot(seurat.p, group.by = 'orig.ident', reduction = 'umap')
```


## <span style='color:green'> Adrenal Medulla Updated </span> 

## <span style='color:green'> Clusters (Before batch correction) </span>

```{r}
adrenal_seu <- readRDS('../data/adrenal_medulla_new/combined_medulla_cc_anno.rds') 
adrenal_ann <- read.table('../data/adrenal_medulla_new/cell_type_annotation_medulla_cc.tsv', sep = '\t')
colnames(adrenal_ann) <- gsub('\\.', '', colnames(adrenal_ann))
adrenal_seu <- AddMetaData(adrenal_seu, adrenal_ann)
a <- DimPlot(adrenal_seu, 
             group.by = 'Identscombined_normal_all_med_red_cc_anno', 
             reduction ='umap', 
             label = TRUE) + NoLegend()
b <- DimPlot(adrenal_seu, 
             group.by = 'orig.ident', 
             reduction ='umap', 
             label = TRUE) + NoLegend()
CombinePlots(list(a, b))
```



```{r eval=FALSE}
adrenal_seu %>% 
        subset(orig.ident == "14933") %>%
        DimPlot(group.by = 'Identscombined_normal_all_med_red_cc_anno', 
             reduction ='umap', 
             label = TRUE) + NoLegend()
```

```{r eval=FALSE}
samps <- unique(adrenal_seu$old.ident)
plots <- list()
for ( i in samps ) {
        ss <- subset(adrenal_seu, orig.ident == i) 
        p <- DimPlot(ss, group.by = 'Identscombined_normal_all_med_red_cc_anno', 
             reduction ='umap', 
             label = TRUE) + NoLegend()
        plots <- c(plots, p)
}
        

adrenal_seu %>% 
        subset(orig.ident == "14933") %>%
        DimPlot(group.by = 'Identscombined_normal_all_med_red_cc_anno', 
             reduction ='umap', 
             label = TRUE) + NoLegend()
```



## <span style='color:green'> Reproducibility of clusters </span> {.tabset}

```{r}
samps <- unique(adrenal_seu$old.ident)
out <- lapply(sort(samps), function(i) {

  a1 <- knitr::knit_expand(text = sprintf("### Sample %s\n", i)) # tab header, auto extracts names of `hcs`
  a2 <- knitr::knit_expand(text = "\n```{r}\n\n") # start r chunk
  a3 <- knitr::knit_expand(text = sprintf("DimPlot(subset(adrenal_seu, orig.ident=='%s'), group.by = 'Identscombined_normal_all_med_red_cc_anno', reduction ='umap', label = TRUE) + NoLegend()", i) ) # extract graphs by "writing" out `hcs[[1]]`, `hcs[[2]]` etc. to be rendered later
  a4 <- knitr::knit_expand(text = "\n```\n") # end r chunk

  paste(a1, a2, a3, a4, collapse = '\n') # collapse together all lines with newline separator

})

```

`r paste(knitr::knit(text = paste(out, collapse = '\n')))`


## <span style='color:green'> Batch correction </span>


```{r}
#ss <- sapply(adrenal_seu$orig.ident, 
#             function(i) 
#               ! i %in% c('13667', '13952', '14627', '14742', '14773'))
#adrenal_seu.s <- adrenal_seu[,ss]
#adrenal_seu.s <- NormalizeData(adrenal_seu.s)
#adrenal_seu.s <- FindVariableFeatures(adrenal_seu.s)
#adrenal_seu.s <- ScaleData(adrenal_seu.s, split.by = "orig.ident", do.center = FALSE)
#adrenal_seu.s <- RunOptimizeALS(adrenal_seu.s, k = 8, lambda = 5, split.by = "orig.ident")
#adrenal_seu.s <- RunQuantileAlignSNF(adrenal_seu.s, 
#                                     split.by = "orig.ident")
#adrenal_seu.s <- RunUMAP(adrenal_seu.s, 
#                         dims = 1:ncol(adrenal_seu[["iNMF"]]), 
#                         reduction = "iNMF")
#DimPlot(adrenal_seu.s, group.by = 'orig.ident', ncol = 3)

adrenal_seu.s <- read_rds('../data/liger_ad_med_batch_correction_updated.rds')
a <- DimPlot(adrenal_seu.s, group.by = c('orig.ident'), label = TRUE) + 
           ggtitle('By sample') + 
           NoLegend()
b <- DimPlot(adrenal_seu.s, 
             group.by = c( 'Identscombined_normal_all_med_red_cc_anno'),
             label = TRUE) +
           ggtitle('By cell type') +
           NoLegend()
CombinePlots(list(b,a), ncol = 2)
```